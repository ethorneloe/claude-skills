name: Validate Skill Versions

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate versions for changed skills
        run: |
          failed=0

          # Get changed skill directories compared to main
          changed_skills=$(git diff --name-only origin/main...HEAD \
            | cut -d/ -f1 | sort -u \
            | while read dir; do
                [ -f "$dir/SKILL.md" ] && echo "$dir"
              done)

          if [ -z "$changed_skills" ]; then
            echo "No skill directories changed — skipping validation."
            exit 0
          fi

          for skill in $changed_skills; do
            echo ""
            echo "=== Checking $skill ==="

            # Check version exists in PR branch
            pr_version=$(grep '^version:' "$skill/SKILL.md" 2>/dev/null | head -1 | sed 's/version:[[:space:]]*//' | tr -d '"')

            if [ -z "$pr_version" ]; then
              echo "FAIL: $skill/SKILL.md is missing a 'version:' field in frontmatter."
              failed=1
              continue
            fi

            echo "PR version: $pr_version"

            # Get version from main branch (may not exist yet)
            main_version=$(git show "origin/main:$skill/SKILL.md" 2>/dev/null \
              | grep '^version:' | head -1 | sed 's/version:[[:space:]]*//' | tr -d '"')

            if [ -z "$main_version" ]; then
              echo "No version on main — new skill or first version. OK."
              continue
            fi

            echo "Main version: $main_version"

            # Compare versions: PR must be strictly greater
            if [ "$pr_version" = "$main_version" ]; then
              echo "FAIL: Version $pr_version is the same as main. Bump the version in $skill/SKILL.md."
              failed=1
              continue
            fi

            # Use sort -V to check ordering
            higher=$(printf '%s\n%s' "$main_version" "$pr_version" | sort -V | tail -1)

            if [ "$higher" != "$pr_version" ]; then
              echo "FAIL: PR version ($pr_version) is not greater than main ($main_version). Bump the version in $skill/SKILL.md."
              failed=1
              continue
            fi

            echo "OK: $pr_version > $main_version"
          done

          echo ""
          if [ "$failed" -ne 0 ]; then
            echo "Version validation failed. Please bump the version in SKILL.md for changed skills."
            exit 1
          fi

          echo "All version checks passed."
