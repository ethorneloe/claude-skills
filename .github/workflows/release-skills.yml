name: Release Skills

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.find.outputs.skills }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 2

      - name: Find changed skill directories
        id: find
        run: |
          skills=$(git diff --name-only HEAD~1..HEAD \
            | cut -d/ -f1 | sort -u \
            | while read dir; do
                [ -f "$dir/SKILL.md" ] && echo "$dir"
              done \
            | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "skills=$skills" >> "$GITHUB_OUTPUT"
          echo "Changed skills: $skills"

  release:
    needs: detect-changes
    if: needs.detect-changes.outputs.skills != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        skill: ${{ fromJson(needs.detect-changes.outputs.skills) }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Read skill metadata
        id: meta
        env:
          SKILL_DIR: ${{ matrix.skill }}
        run: |
          version=$(grep '^version:' "$SKILL_DIR/SKILL.md" | head -1 | sed 's/version:[[:space:]]*//' | tr -d '"')
          name=$(grep '^name:' "$SKILL_DIR/SKILL.md" | head -1 | sed 's/name:[[:space:]]*//' | tr -d '"')

          # Validate format
          if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+(\.[0-9]+)?$'; then
            echo "Error: Invalid version format: $version"
            exit 1
          fi
          if ! echo "$name" | grep -qE '^[a-zA-Z0-9_-]+$'; then
            echo "Error: Invalid name format: $name"
            exit 1
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "name=$name" >> "$GITHUB_OUTPUT"
          echo "Releasing $name v$version"

      - name: Create zip
        env:
          SKILL_DIR: ${{ matrix.skill }}
          SKILL_NAME: ${{ steps.meta.outputs.name }}
          SKILL_VERSION: ${{ steps.meta.outputs.version }}
        run: |
          cd "$SKILL_DIR"
          zip -r "../${SKILL_NAME}-v${SKILL_VERSION}.zip" .

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKILL_NAME: ${{ steps.meta.outputs.name }}
          SKILL_VERSION: ${{ steps.meta.outputs.version }}
        run: |
          tag="${SKILL_NAME}/v${SKILL_VERSION}"
          zip_file="${SKILL_NAME}-v${SKILL_VERSION}.zip"

          # Delete existing release/tag if re-releasing same version
          gh release delete "$tag" --yes 2>/dev/null || true
          git push origin ":refs/tags/$tag" 2>/dev/null || true

          gh release create "$tag" "$zip_file" \
            --title "${SKILL_NAME} v${SKILL_VERSION}" \
            --notes "Release of **${SKILL_NAME}** skill package v${SKILL_VERSION}." \
            --latest
